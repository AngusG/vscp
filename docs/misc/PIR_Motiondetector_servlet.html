<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [TINI] ANN:  PIR_Servlet.java - A PIR (Pyroelectric-Infra-Red) Motion Detector Servlet for TINI/1-Wire.</TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:bebop1%40earthlink.net">
   <LINK REL="Previous"  HREF="027042.html">
   <LINK REL="Next" HREF="027032.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[TINI] ANN:  PIR_Servlet.java - A PIR (Pyroelectric-Infra-Red) Motion Detector Servlet for TINI/1-Wire.</H1>
    <B>Kelly Smith</B> 
    <A HREF="mailto:bebop1%40earthlink.net"
       TITLE="[TINI] ANN:  PIR_Servlet.java - A PIR (Pyroelectric-Infra-Red) Motion Detector Servlet for TINI/1-Wire.">bebop1@earthlink.net</A><BR>
    <I>Tue, 17 Jun 2003 03:38:20 -0700</I>
    <P><UL>
        <LI> Previous message: <A HREF="027042.html">[TINI] Serial problems with DS400</A></li>
        <LI> Next message: <A HREF="027032.html">FW: [TINI] Execute a second Java process without Slush</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27051">[ date ]</a>
              <a href="thread.html#27051">[ thread ]</a>
              <a href="subject.html#27051">[ subject ]</a>
              <a href="author.html#27051">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>All - I know that some of you are involved in home automation applications
for TINI/1-Wire, and I thought I would share this...  Applications:
Portions of this code and the PIR Motion Detector H/W (with the addition of
a DS2406 1-Wire switch), could be used to trigger a NickClick camera (for
instance).

Ref:  Shawn Silverman's NickClick software at:

  <A HREF="http://www.ee.umanitoba.ca/~shawn/projects/nickclick/">http://www.ee.umanitoba.ca/~shawn/projects/nickclick/</A>

Best regards, Kelly Smith


The PIR_Servlet code starts here...cut'n'paste, as needed.

/*
PIR_Servlet.java - A PIR (Pyroelectric-Infra-Red) Motion Detector Servlet
for TINI.

Change History
==============

Initial release: June 15, 2003
PIR_Servlet 1.0 - Copyright (C) 2003 by Kelly Smith (E-Mail:
<A HREF="mailto:bebop1@earthlink.net">bebop1@earthlink.net</A>).
This software is provided under the GNU general public license.

PIR_Servlet 1.1 - Removed activity latch display from the Telnet output.
Added a
little more descriptive information in this source code header.

Description
===========

PIR_Servlet uses a  PIR Motion Sensor from Radioshack - $19.95,
Catalog #: 980-0777 Model: MS13A PIR Motion Sensor. The range,
is up to 20 feet.

This was EASY to do with an off-the-shelf PIR motion detector (and cheap),
that is intended for X10 wireless usage. I &quot;dead-bugged&quot; a DS2406 TO-92,
across the visible red LED (LED cathode to ground and DS2406) pin-1,
with LED anode and DS2406 pin-3 is PIO-A; DS2406 Data pin-2 is 1-Wire).

PIR_Servlet includes a very rudimentary tagging capability. You can turn
a Dallas Semiconductor DS2406 switch on (Channel State) to determine
where it is, and then enter a description. This information is then saved in
a
properties file on the TINI. Once a DS2406 switch has been given a
description,
and update is selected, it is added to the PIR_Servlet pull-down menu.

Note, that when the Channel-A state is &quot;On&quot;, the PIR Motion Sensor's LED
will
remain off (and no activity will be sensed).  This then indicates the
location
of the PIR Motion Sensor to be used for tagging by a physical location in
the
description. For example: &quot;PIR Motion Detector #7 - Bedroom&quot;.

Channel-A state for &quot;Off&quot; or &quot;On&quot; is indicated by a box, changing from black
to green.

Motion sensing is indicated by an &quot;Activity&quot; Yes/No display, and &quot;Level&quot;
(state detection) is indicated by a box indicator changing from black to
green.

Property file format
====================

The 'desctbl.props' (Decsription Table Properties) file format contains a
summary
list of &quot;tagged&quot; DS2406 1-Wire devices.  As an example:

#Device List
#Sun Jun 15 08:24:32 PST 2003
5C00000019C6BA12=PIR Motion Detector #1 - Living Room

*/

import javax.servlet.*;
import javax.servlet.http.*;

import java.io.*;
import java.util.Properties;
import java.util.Enumeration;

import com.dalsemi.onewire.OneWireAccessProvider;
import com.dalsemi.onewire.OneWireException;
import com.dalsemi.onewire.adapter.DSPortAdapter;
import com.dalsemi.onewire.container.OneWireContainer;
import com.dalsemi.onewire.container.OneWireContainer12;
import com.dalsemi.onewire.utils.Address;

/**
 * Title:		PIR_Servlet
 * Description:	PIR Motion Detector 1-Wire Servlet
 * Copyright:	Copyright (C) 2003
 * Company:		iPpliance
 * @author:		Kelly Smith
 * @version:	1.1
 */

public class PIR_Servlet extends HttpServlet {

    public PIR_Servlet() {
    }

    public void init(ServletConfig config) throws
javax.servlet.ServletException {
        super.init( config);

        try {
            FileInputStream     f = new FileInputStream( DESCTBLNAME );

            descTbl.load( f );
            f.close();
        }
        catch( Exception e ) {
            log( &quot;Unable to load descriptions table&quot;, e );
        }
    }

    protected void doPost(HttpServletRequest req, HttpServletResponse resp)
throws javax.servlet.ServletException, java.io.IOException {
        doGet( req,  resp);
    }

    protected void doGet(HttpServletRequest req, HttpServletResponse res)
    throws javax.servlet.ServletException, java.io.IOException
    {

	// &quot;Soft-wired&quot; values for adapter, port, device
/*
        String adapter = req.getParameter( ADAPTER);
        String port = req.getParameter( PORT);
        String device = req.getParameter( DEVICE);
*/

	// &quot;Hard-wired&quot; values for adapter, port, device
        String adapter = &quot;TINIExternalAdapter&quot;;
        String port = &quot;serial1&quot;;
        String device = &quot;5C00000019C6BA12&quot;;

		// Check to see if an TINIExternalAdapter, serial1 port,1-Wire device  is
present
        if( adapter  == null || port == null
        ||  device == null || device.length() != 16)
        {

// DEBUG
System.out.println(&quot;PIR_Servlet: adapter = &quot; + adapter);
System.out.println(&quot;PIR_Servlet: port = &quot; + port);
System.out.println(&quot;PIR_Servlet: device = &quot; + device);

                throw new ServletException(
                        getClass().getName() + &quot;: Invalid adapter/port or
1-Wire!&quot;);
        }
        byte[] id = Address.toByteArray( device);

        // Do HTTP header stuff
        res.setContentType( &quot;text/html&quot;);

        // Get Writer
        PrintWriter pw = res.getWriter();

        // Start HTML
        pw.println( &quot;&lt;html&gt;&quot;);
        pw.println( &quot;&lt;head&gt;&lt;title&gt;PIR Motion Detector 1-Wire Servlet,
v1.1&lt;/title&gt;&lt;/head&gt;&quot;);
        pw.println( &quot;&lt;body&gt;&quot;);


        DSPortAdapter pa = null;
        try
        {
            pa = getAdapter( adapter, port);
            OneWireContainer12 ib = new OneWireContainer12();
            ib.setupContainer( pa, id );

            if( ib.isPresent() ) {
                setDescription( ib.getAddressAsString(), req.getParameter(
DESCRIPTION_PARAM ) );
                doLatchChanges( ib, req );
            }

            sendBody( pw, pa, ib, req.getContextPath() );
        }
        catch( Exception e) {
//            sendAlert( pw, e);
            pw.println( &quot;&lt;P&gt;Error: &quot; + e.getMessage());
        }

        // Finish HTML
        pw.println(&quot;&lt;/body&gt;&lt;/html&gt;&quot;);
    }

    public void sendBody( PrintWriter pw,
                          DSPortAdapter pa,
                          OneWireContainer12 ib,
                          String path ) throws OneWireException
    {
        if( ib.isPresent())
        {
            byte[]          state = ib.readDevice();
            StringBuffer    buf = new StringBuffer( 2000 );
            String          addr = ib.getAddressAsString();
            boolean         switchState;


            buf.append( &quot;&lt;div align='center'&gt;\n&quot; );
            buf.append( &quot;&lt;h2&gt;&quot; );
            buf.append( ib.getName() );
            buf.append( &quot;&lt;/h2&gt;\r\n&quot; );

            // form to pick devices
            buf.append( &quot;&lt;form action='&quot; );
            buf.append( path );
            buf.append( &quot;/servlet/PIR_Servlet' method='get'&gt;\r\n&quot; );

            buf.append( &quot;&lt;table&gt;\n&quot; );
            buf.append( &quot;&lt;tr&gt;\n&quot; );
            buf.append( &quot;&lt;td&gt;\n&quot; );

            buf.append( getDeviceSelection( addr ) );

            buf.append( &quot;&lt;/td&gt;\n&quot; );
            buf.append( &quot;&lt;td&gt;\n&quot; );
            buf.append( &quot;&lt;input type='submit' value='Go'&gt;\n&quot; );
            buf.append( &quot;&lt;/td&gt;\n&quot; );
            buf.append( &quot;&lt;/tr&gt;\n&quot; );
            buf.append( &quot;&lt;/table&gt;\n&quot; );

            buf.append( &quot;&lt;input type='hidden' name='adapter' value='&quot; );
            buf.append( pa.getAdapterName() );
            buf.append( &quot;'&gt;\r\n&quot; );

            buf.append( &quot;&lt;input type='hidden' name='port' value='&quot; );
            buf.append( pa.getPortName() );
            buf.append( &quot;'&gt;\r\n&quot; );

            buf.append( &quot;&lt;/form&gt;\n&quot; );

            pw.println( buf );
            buf.setLength( 0 );


            // form to set switches
            buf.append( &quot;&lt;form action='&quot; );
            buf.append( path );
            buf.append( &quot;/servlet/PIR_Servlet' method='get'&gt;\r\n&quot; );

            buf.append( &quot;&lt;p&gt;&lt;b&gt;\n&quot; );
            buf.append( &quot;            Description:&quot; );
            buf.append( &quot;&lt;/b&gt;&lt;br&gt;\n&quot; );

            buf.append( &quot;&lt;input type='text' name='desc' size='40'
maxlength='40'&quot; );

            String desc = descTbl.getProperty( addr );
            if( desc != null ) {
                buf.append( &quot; value='&quot; );
                buf.append( desc );
                buf.append( &quot;' &quot; );
            }
            buf.append( &quot;&gt;\n&quot; );

            buf.append( &quot;&lt;p&gt;\n&quot; );
            buf.append( &quot;&lt;table border='1' bordercolor='Black'&gt;\n&quot; );
            buf.append( &quot;&lt;tr&gt;\n&quot; );
            buf.append( &quot;&lt;td&gt;\n&quot; );
            buf.append( &quot;&lt;table cellpadding='2' bgcolor='Silver'&gt;\n&quot; );
            buf.append( &quot;&lt;tr&gt;\n&quot; );
            buf.append( &quot;&lt;th&gt;&amp;nbsp;&lt;/th&gt;\n&quot; );
            buf.append( &quot;&lt;th&gt;Current&lt;/th&gt;\n&quot; );
            buf.append( &quot;&lt;th colspan='2' align='center'&gt;New State&lt;/th&gt;\n&quot; );
            buf.append( &quot;&lt;th&gt;&amp;nbsp;&lt;/th&gt;\n&quot; );
            buf.append( &quot;&lt;th&gt;&amp;nbsp;&lt;/th&gt;\n&quot; );
            buf.append( &quot;&lt;/tr&gt;\n&quot; );
            buf.append( &quot;&lt;tr&gt;\n&quot; );
            buf.append( &quot;&lt;th&gt;Channel&lt;/th&gt;\n&quot; );
            buf.append( &quot;&lt;th&gt;State&lt;/th&gt;\n&quot; );
            buf.append( &quot;&lt;th&gt;Off&lt;/th&gt;\n&quot; );
            buf.append( &quot;&lt;th&gt;On&lt;/th&gt;\n&quot; );
            buf.append( &quot;&lt;th&gt;Activity&lt;/th&gt;\n&quot; );
            buf.append( &quot;&lt;th&gt;Level&lt;/th&gt;\n&quot; );
            buf.append( &quot;&lt;/tr&gt;\n&quot; );
            buf.append( &quot;&lt;tr&gt;\n&quot; );
            buf.append( &quot;&lt;td colspan='6' align='center'&gt;&lt;hr&gt;&lt;/td&gt;\n&quot; );
            buf.append( &quot;&lt;/tr&gt;\n&quot; );

            pw.println( buf );
            buf.setLength( 0 );

            // switch data
            int nSwitches = ib.getNumberChannels( state );
            for (int i=0; i &lt; nSwitches ; i++) {
                buf.append( &quot;&lt;tr&gt;\n&quot; );

                buf.append( &quot;&lt;th&gt;&quot; );
                buf.append( (char)('A' + i) );
                buf.append( &quot;&lt;/th&gt;\r\n&quot; );

                buf.append( &quot;&lt;th width='30' align='center'&gt;\n&quot; );
                buf.append( &quot;&lt;table width='100%' bordercolor='Gray'
border='1'&gt;\n&quot; );
                buf.append( &quot;&lt;tr&gt;\n&quot; );

                buf.append( &quot;&lt;td bgcolor='#&quot; );
                switchState = ib.getLatchState( i, state );
                buf.append( switchState ? &quot;1cff1c&quot; : &quot;1c1c1c&quot; );
                buf.append( &quot;'&gt;\n&quot; );

                buf.append( &quot;&amp;nbsp;&quot; );
                buf.append( &quot;&lt;/td&gt;\n&quot; );
                buf.append( &quot;&lt;/tr&gt;\n&quot; );
                buf.append( &quot;&lt;/table&gt;\n&quot; );
                buf.append( &quot;&lt;/th&gt;\n&quot; );

                buf.append( &quot;&lt;td&gt;&lt;input type='radio' name='channel&quot; );
                buf.append( i );
                buf.append( &quot;' value='0'&quot; );
                if( !switchState )
                    buf.append( &quot; checked&quot; );
                buf.append( &quot;&gt;&lt;/td&gt;\n&quot; );

                buf.append( &quot;&lt;td&gt;&lt;input type='radio' name='channel&quot; );
                buf.append( i );
                buf.append( &quot;' value='1'&quot; );
                if( switchState )
                    buf.append( &quot; checked&quot; );
                buf.append( &quot;&gt;&lt;/td&gt;\n&quot; );

                buf.append( &quot;&lt;td align='center'&gt;&quot; );
                if( ib.hasActivitySensing() ) {
                    buf.append( ib.getSensedActivity( i, state ) ? &quot;Yes&quot; :
&quot;No&quot; );
                }
                else {
                    buf.append( &quot;-&quot; );
                }
                buf.append( &quot;&lt;/td&gt;\n&quot; );

                buf.append( &quot;&lt;td width='30' align='center'&gt;\n&quot; );
                buf.append( &quot;&lt;table width='100%' bordercolor='Gray'
border='1'&gt;\n&quot; );
                buf.append( &quot;&lt;tr&gt;\n&quot; );

                buf.append( &quot;&lt;td bgcolor='#&quot; );

                if( ib.hasLevelSensing() ) {
                    buf.append( ib.getLevel( i, state ) ? &quot;1cff1c&quot; :
&quot;1c1c1c&quot; );
                }
                else {
                    buf.append( &quot;ffffff&quot; );
                }
                buf.append( &quot;'&gt;\n&quot; );

                buf.append( &quot;&amp;nbsp;&quot; );
                buf.append( &quot;&lt;/td&gt;\n&quot; );
                buf.append( &quot;&lt;/tr&gt;\n&quot; );
                buf.append( &quot;&lt;/table&gt;\n&quot; );
                buf.append( &quot;&lt;/td&gt;\n&quot; );
                buf.append( &quot;&lt;/tr&gt;\n&quot; );
                buf.append( &quot;&lt;tr&gt;\n&quot; );
                buf.append( &quot;&lt;td colspan='6' align='center'&gt;&lt;hr&gt;&lt;/td&gt;\n&quot; );
                buf.append( &quot;&lt;/tr&gt;\n&quot; );

                pw.println( buf );
                buf.setLength( 0 );
	    }

            buf.append( &quot;&lt;tr&gt;\n&quot; );
            buf.append( &quot;&lt;td colspan='3' align='center'&gt;&lt;input
type='Checkbox' name='clearActivity' value='true'&gt;Clear activity&lt;/td&gt;\n&quot; );
            buf.append( &quot;&lt;td colspan='3' align='center'&gt;&lt;input type='submit'
value='Update'&gt;&lt;/td&gt;\n&quot; );
            buf.append( &quot;&lt;/tr&gt;\n&quot; );
            buf.append( &quot;&lt;/table&gt;\n&quot; );
            buf.append( &quot;&lt;/td&gt;\n&quot; );
            buf.append( &quot;&lt;/tr&gt;\n&quot; );
            buf.append( &quot;&lt;/table&gt;\n&quot; );

            buf.append( &quot;&lt;input type='hidden' name='adapter' value='&quot; );
            buf.append( pa.getAdapterName() );
            buf.append( &quot;'&gt;\n&quot; );

            buf.append( &quot;&lt;input type='hidden' name='port' value='&quot; );
            buf.append( pa.getPortName() );
            buf.append( &quot;'&gt;\n&quot; );

            buf.append( &quot;&lt;input type='hidden' name='device' value='&quot; );
            buf.append( addr );
            buf.append( &quot;'&gt;\n&quot; );
            buf.append( &quot;&lt;/form&gt;\n&quot; );
            buf.append( &quot;&lt;/div&gt;\n&quot; );

            pw.println( buf );
        }
        else
        {
            pw.println( &quot;&lt;H1&gt;1-Wire Device Not Found&lt;/H1&gt;&quot;);
            pw.print( &quot;1-Wire device &quot;);
            pw.print( ib.getAddressAsString());
            pw.print( &quot; is not present on adapter '&quot;);
            pw.print( pa.getAdapterName());
            pw.print( &quot;' on port '&quot;);
            pw.print( pa.getPortName());
            pw.println( &quot;'.&quot;);
        }
    }

	protected static final DSPortAdapter getAdapter( String adapterName)
	throws OneWireException
	{
		Enumeration paEnum = OneWireAccessProvider.enumerateAllAdapters();

		while( paEnum.hasMoreElements())
		{
			DSPortAdapter pa = (DSPortAdapter)paEnum.nextElement();
			String paName = pa.getAdapterName();
			if( paName != null &amp;&amp; paName.equals( adapterName))
				return pa;
		}

		throw new OneWireException( &quot;Adapter &quot; +
			adapterName + &quot; is not supported on this platform.&quot;);
	}

	protected static final DSPortAdapter getAdapter(
		String adapterName, String port)
	throws OneWireException
	{
		DSPortAdapter pa = getAdapter( adapterName);
		if( pa.selectPort( port))
		{
			if( pa.adapterDetected())
			{
				// Caller must free port
				return pa;
			}
		}

		throw new OneWireException( &quot;Adapter &quot; +
			adapterName + &quot; is not detected on port &quot; + port + &quot;.&quot;);
	}

    private StringBuffer getDeviceSelection( String currAddr ) {
	StringBuffer            buf = new StringBuffer( 2000 );
        String                  devID;

	buf.append( &quot;&lt;select name='device' id='device' width='40'&gt;\n&quot; );

        Enumeration     keys = descTbl.keys();

        while( keys.hasMoreElements() ) {
            devID = (String)keys.nextElement();

	    buf.append( &quot;&lt;option value='&quot; );
            buf.append( devID );
            buf.append( '\'' );

            if( devID.equals( currAddr ) ) {
                buf.append( &quot; SELECTED&gt;[&quot; );
                buf.append( descTbl.getProperty( devID ) );
                buf.append( &quot;]&quot; );
            }
            else {
                buf.append( '&gt;' );
                buf.append( descTbl.getProperty( devID ) );
            }
            buf.append( &quot;&lt;/option&gt;\n&quot; );
        }

        if( !descTbl.containsKey( currAddr ) ) {
            buf.append( &quot;&lt;option value='&quot; );
            buf.append( currAddr );
            buf.append( &quot;' SELECTED&gt;[&quot; );
            buf.append( currAddr );
            buf.append( &quot;]&lt;/option&gt;&quot; );
        }

        buf.append( &quot;&lt;/select&gt;\n&quot; );

        return buf;
    }

    private void doLatchChanges( OneWireContainer12 ib, HttpServletRequest
req )
        throws OneWireException
    {
        if( ib.isPresent())
        {
            byte[]      state = ib.readDevice();
            int         nSwitches = ib.getNumberChannels( state );
            boolean     needsUpdate = false;
            String      s;
            int         newStateVal;
            boolean     newLatchState;

            for( int i=0; i &lt; nSwitches ; i++ ) {
                String latchStateStr = req.getParameter( CHANNEL_PARAM +
i );

                if( latchStateStr != null ) {
                    try {
                        newStateVal = Integer.parseInt( latchStateStr );
                        newLatchState = false;

                        switch( newStateVal ) {
                            case -1:
                                // toggle
                                newLatchState = !ib.getLatchState( i,
state );
                                break;

                            case 0:
                                // off
                                newLatchState = false;
                                break;

                            case 1:
                                // on
                                newLatchState = true;
                                break;
                        }

                        if( newLatchState != ib.getLatchState( i, state ) )
{
                            ib.setLatchState( i, newLatchState, false,
state );
                            needsUpdate = true;
                        }
                    }
                    catch( NumberFormatException e ) {
                        this.log( &quot;Value for latchState should be -1, 0, or
1, was &quot; + latchStateStr, e );
                    }
                }
            }

            s = req.getParameter( CLRACTIVITY_PARAM );

// Comment this line out, if you don't want the activity latch displayed
//            log( s + &quot; : &quot; +  Boolean.valueOf( s ) );

            if( Boolean.valueOf( s ).booleanValue() ) {
                ib.clearActivity();
                needsUpdate = true;
            }

            if( needsUpdate ) {
                ib.writeDevice( state );
            }
        }
    }

    private void setDescription( String addr, String desc ) {
        String      oldValue = descTbl.getProperty( addr );

        if( addr == null || desc == null )
            return;

        if( oldValue == null || !oldValue.equals( desc ) ) {
            descTbl.put( addr, desc );
            try {
                FileOutputStream    f = new FileOutputStream( DESCTBLNAME );

                descTbl.save( f, &quot;Device List&quot; );
                f.close();
            }
            catch( Exception e ) {
                log( &quot;Error saving description table&quot;, e );
            }
        }
    }


    private Properties          descTbl = new Properties();

    public static final String  CHANNEL_PARAM = &quot;channel&quot;;
    public static final String  DESCRIPTION_PARAM = &quot;desc&quot;;
    public static final String  CLRACTIVITY_PARAM = &quot;clearActivity&quot;;

    private static final String DESCTBLNAME = &quot;desctbl.props&quot;;

	public static final String ADAPTER = &quot;adapter&quot;;
	public static final String PORT    = &quot;port&quot;;
	public static final String DEVICE  = &quot;device&quot;;
	public static final String BANK    = &quot;bank&quot;;
}


</pre>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="027042.html">[TINI] Serial problems with DS400</A></li>
	<LI> Next message: <A HREF="027032.html">FW: [TINI] Execute a second Java process without Slush</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27051">[ date ]</a>
              <a href="thread.html#27051">[ thread ]</a>
              <a href="subject.html#27051">[ subject ]</a>
              <a href="author.html#27051">[ author ]</a>
         </LI>
       </UL>
</body></html>
